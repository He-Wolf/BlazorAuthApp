@page "/todos"
@attribute [Authorize]
@using System.Net.Http
@using System.Net.Http.Headers
@using System.Net.Http.Json
@using TodoApi.Shared.Models
@using TodoApi.Client.Services
@inject AuthenticationStateProvider _authStateProv
@inject IJSRuntime _jsRuntime
@inject HttpClient _httpClient


<AuthorizeView>
    <div class="row mx-2 mb-2 justify-content-md-center">
        <div class="col"></div>
        <div class="col-md-4">
            @foreach (var todoItem in todos)
            {
                <Todo todo.Id="@todoItem.Id" todo.Name="@todoItem.Name" todo.IsComplete="@todoItem.IsComplete"/>
            }
            <TodoAdd/>
        </div>
        <div class="col"></div>
    </div>
</AuthorizeView>

@code {
    private List<TodoViewModel> todos;
    
    protected override async Task OnInitializedAsync()
    {
        JWTAuthStateProvider _jwtAuthStateProv = new JWTAuthStateProvider(_jsRuntime);
        
        _jwtAuthStateProv = _authStateProv as JWTAuthStateProvider;

        var token = await _jwtAuthStateProv.GetTokenAsync();

        _httpClient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("bearer", token);
            
        todos = await _httpClient.GetFromJsonAsync<List<TodoViewModel>>("/api/TodoItems");
    }
}
