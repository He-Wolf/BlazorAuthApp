@attribute [Authorize]
@using System.Net.Http
@using System.Net.Http.Headers
@using System.Net.Http.Json
@using TodoApi.Shared.Models
@using TodoApi.Client.Services
@inject AuthenticationStateProvider _authStateProv
@inject IJSRuntime _jsRuntime
@inject HttpClient _httpClient



<div class="card">
    <div class="card-body">
        <EditForm Model="@todo" OnValidSubmit="Apply">
            <div class="form-group row">
                <label for="inputName" class="col-sm-3 col-form-label">Name:</label>
                <div class="col-sm-9">
                    <input type="text" @attributes="NameAttributes" id="inputName" @bind-value="todo.Name"/>
                </div>
            </div>
            <div class="form-group form-check">
                <input type="checkbox" @attributes="IsCompleteAttributes" class="form-check-input" id="inputIsComplete" @bind-value="todo.IsComplete">
                <label class="form-check-label" for="inputIsComplete">I have done it.</label>
            </div>
            @if(!ifEdit && !ifDelete)
            {
                <button type="button" class="btn btn-primary" @onclick="@(() => { Edit(); })">Edit</button>
                <button type="button" class="btn btn-primary" @onclick="@(() => { Delete(); })">Delete</button>
            }
            else if (ifEdit)
            {
                <button type="submit" class="btn btn-danger" @onclick="@(async() => { await Confirm(); })">Confirm</button>
                <button type="button" class="btn btn-secondary" @onclick="@(async() => { await Cancel(); })">Cancel</button>
            }
            else if (ifDelete)
            {
                <button type="submit" class="btn btn-primary" @onclick="@(async() => { await Apply(); })">Apply</button>
                <button type="button" class="btn btn-secondary" @onclick="@(async() => { await Cancel(); })">Cancel</button>
            }
        </EditForm>
    </div>
</div>

@code{
    private TodoViewModel todo = new TodoViewModel();
    private bool ifEdit = false;
    private bool ifDelete = false;
    private Dictionary<string, object> NameAttributes { get; set; } =
        new Dictionary<string, object>()
        {
            { "readonly", "readonly" },
            { "class", "form-control-plaintext" }
        };
    private Dictionary<string, object> IsCompleteAttributes { get; set; } =
        new Dictionary<string, object>()
        {
            { "disabled", "disabled" }
        };
    
    protected override async Task OnInitializedAsync()
    {
        JWTAuthStateProvider _jwtAuthStateProv = new JWTAuthStateProvider(_jsRuntime);
        
        _jwtAuthStateProv = _authStateProv as JWTAuthStateProvider;

        var token = await _jwtAuthStateProv.GetTokenAsync();

        _httpClient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("bearer", token);
            
        //user = await _httpClient.GetFromJsonAsync<DisplayViewModel>("/Account/Display");
    }
    
    private async Task Apply()
    {
        var response = await _httpClient.PutAsJsonAsync("/api/TodoItems", todo);
        var content = await response.Content.ReadFromJsonAsync<TodoViewModel>();

        ifEdit = false;
        NameAttributes.Add("readonly", "readonly");
        NameAttributes["class"] = "form-control-plaintext";
        IsCompleteAttributes.Add("disabled", "disabled");
        todo = await _httpClient.GetFromJsonAsync<TodoViewModel>("/api/TodoItems");
    }
    private async Task Confirm()
    {
        var response = await _httpClient.PutAsJsonAsync("/api/TodoItems", todo);
        var content = await response.Content.ReadFromJsonAsync<TodoViewModel>();

        ifEdit = false;
        NameAttributes.Add("readonly", "readonly");
        NameAttributes["class"] = "form-control-plaintext";
        IsCompleteAttributes.Add("disabled", "disabled");
        todo = await _httpClient.GetFromJsonAsync<TodoViewModel>("/api/TodoItems");
    }
    private async Task Cancel()
    {
        ifEdit = false;
        ifDelete = false;
        NameAttributes.Add("readonly", "readonly");
        NameAttributes["class"] = "form-control-plaintext";
        IsCompleteAttributes.Add("disabled", "disabled");
        todo = await _httpClient.GetFromJsonAsync<TodoViewModel>("/api/TodoItems");
    }
    private void Edit()
    {
        ifEdit = true;
        NameAttributes.Remove("readonly");
        NameAttributes["class"] = "form-control";
        IsCompleteAttributes.Remove("disabled");
    }
    private void Delete()
    {
        ifDelete = true;
    }
}